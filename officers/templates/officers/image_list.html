<div class="container">
    <h2>Bộ ảnh của {{ officer.birth_name }}</h2>

    <!-- Warning Modal for no selection -->
    <div id="warningModal"
         style="display: none;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: #f8d7da;
                color: #721c24;
                padding: 20px;
                border: 1px solid #f5c6cb;
                border-radius: 5px;
                z-index: 1000">
        <p>Please select at least one officer to export data.</p>
        <div style="text-align: center;
                    margin-top: 10px">

            <button onclick="closeWarningModal()"
                    style="background-color: #721c24;
                           color: white;
                           border: none;
                           padding: 5px 10px;
                           cursor: pointer;
                           border-radius: 3px">OK</button>
        </div>
    </div>

    <!-- Form for selecting and downloading images -->
    <form id="downloadForm"
          method="post"
          action="{% url 'url_download_selected_images' officer.pk %}"
          onsubmit="return validateImageSelection()">
        {% csrf_token %}

        <!-- Upload and Back Buttons -->
        <div class="mb-3">
            <a href="{% url 'officer_detail' officer.pk %}"
               class="btn btn-secondary">Quay lại</a>
            <a href="{% url 'url_image_create' officer.pk %}"
               class="btn btn-primary">Tải ảnh lên</a>
        </div>

        <!-- Category Filter Dropdown -->
        <select id="categoryDropdown"
                class="form-control mb-3"
                onchange="filterCategory()">
            <option value="">Tất cả</option>

            {% for key, label in category_labels.items %}
                <option value="{{ key }}" 
                    {% if request.GET.category == key %}selected{% endif %}
                    >{{ label }}</option>
            {% endfor %}

        </select>

        <!-- Select All Checkbox -->
        <div class="form-check mb-3">
            <input type="checkbox"
                   id="selectAllCheckbox"
                   class="form-check-input"
                   onclick="toggleSelectAll(this)" />
            <label for="selectAllCheckbox"
                   class="form-check-label">Chọn tất cả ảnh</label>
        </div>

        <!-- Download Selected button -->
        <button type="submit"
                class="btn btn-success mb-3">Tải ảnh đã chọn</button>

        <!-- Display images with checkboxes for selection -->
        <div id="images"
             class="image-grid mt-3">

            {% for image in images %}
                <div class="image-item">
                    <!-- Checkbox to select image for download -->
                    <input type="checkbox"
                           name="selected_images"
                           value="{{ image.pk }}"
                           class="image-checkbox mr-2" />
                    <img src="{{ image.image.url }}"
                         alt="{{ image.description }}"
                         class="img-thumbnail"
                         style="max-width: 150px" />
                    <p>{{ image.description }}</p>
                    <a href="{{ image.image.url }}"
                       download
                       class="btn btn-sm btn-success">Download</a>
                    <a href="{% url 'url_image_update' officer.pk image.pk %}"
                       class="btn btn-sm btn-warning">Cập nhật</a>
                    <a href="{% url 'url_image_delete' officer.pk image.pk %}"
                       class="btn btn-sm btn-danger">Xoá</a>
                </div>
            {% empty %}
                <p>Không có ảnh nào trong danh mục này.</p>
            {% endfor %}

        </div>
    </form>
</div>

<script>
    function filterCategory() {
        const category = document.getElementById("categoryDropdown").value;
        const url = new URL(window.location.href);
        url.searchParams.set("category", category);
        window.location.href = url.toString();
    }

    function toggleSelectAll(selectAllCheckbox) {
        const imageCheckboxes = document.querySelectorAll(".image-checkbox");
        imageCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
    }

    function validateImageSelection() {
        const imageCheckboxes = document.querySelectorAll(".image-checkbox");
        const isAnyImageSelected = Array.from(imageCheckboxes).some(checkbox => checkbox.checked);

        if (!isAnyImageSelected) {
            showWarningModal("Vui lòng chọn ít nhất một ảnh để tải xuống.");
            return false; // Prevent form submission
        }

        return true; 
    }

    // Function to show the warning modal with a custom message
    function showWarningModal(message) {
        const warningModal = document.getElementById("warningModal");
        warningModal.querySelector("p").innerText = message; // Set custom message
        warningModal.style.display = "block";
    }

    // Function to close the warning modal
    function closeWarningModal() {
        document.getElementById("warningModal").style.display = "none";
    }
</script>
