{% load static tailwind_tags %}

<div class="navbar bg-base-200 mb-10 shadow-inner drop-shadow-md">
    {% tailwind_css %}
    <div class="flex-1">
        <h2 class="font-semibold text-2xl ml-20">THÔNG TIN CÁN BỘ</h2>
    </div>
    <div class="flex-none">
        <div class="flex-none tooltip tooltip-bottom"
             data-tip="Tìm kiếm">
            <button class="btn btn-md btn-circle btn-ghost">
                <img src="{% static 'src/search.png' %}"
                     alt="Search Icon"
                     class="w-5 h-5" />
            </button>
        </div>
        <a href="{% url 'officer_create' %}"
           class="btn btn-ghost rounded-md">
            <span class="text-lg">Thêm mới cán bộ</span>
            <img src="{% static 'src/add-user.png' %}"
                 alt="Add user"
                 class="w-5 h-5" />
        </a>

        <a href="{% url 'excel_upload' %}"
           class="btn btn-ghost rounded-md">
            <span class="text-lg">Tải lên từ Excel</span>
            <img src="{% static 'src/upload.png' %}"
                 alt="Upload icon"
                 class="w-5 h-5" />
        </a>

        {% if officers %}
            <a href="{% url 'delete_all_officers' %}"
               class="btn btn-ghost rounded-md text-red-600 text-lg">Xoá tất cả</a>
        {% endif %}

        <button>

            {% if user.is_authenticated %}
                <!-- <p>Chào mừng, {{ user.username }}! </p> -->
                <form method="POST"
                      action="{% url 'logout' %}">
                    {% csrf_token %}
                    <button type="submit"
                            class="btn btn-ghost rounded-md text-lg">
                        Đăng xuất
                    </button>
                </form>
            {% else %}
                <a href="{% url 'login' %}">Đăng nhập</a>
            {% endif %}

        </button>
    </div>
</div>

<!-- Warning Message Modal (initially hidden) -->
<div id="warningModal"
     style="display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #f8d7da;
            color: #721c24;
            padding: 20px;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            z-index: 1000">
    <div style="text-align: center;
                margin-top: 10px">

        <button onclick="closeWarningModal()"
                style="background-color: #721c24;
                       color: white;
                       border: none;
                       padding: 5px 10px;
                       cursor: pointer;
                       border-radius: 3px">OK</button>
    </div>
</div>

<!-- Display messages -->

{% if messages %}

    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mb-10">{{ message }}</div>
    {% endfor %}

{% endif %}


<!-- Checkbox to toggle between officer list and export form -->
<label class="font-semibold ml-10 text-lg">
    <input type="checkbox"
           id="toggleExportForm"
           onclick="toggleView()" />
    Xuất dữ liệu
</label>

<div class="flex divide-x">
    <!-- Officer List and Filter Form -->
    <div id="officerList"
         class="mx-20 w-3/5">
        <table class="table">
            <thead>
                <tr>
                    <th></th>
                </tr>
            </thead>

            {% for officer in officers %}
                <tbody class="mx-10 text-lg">
                    <tr>
                        <th>1</th>
                        <td>{{ officer.birth_name }}</td>
                        <td>{{ officer.birth_year }}</td>
                        <td>{{ officer.work_unit }}</td>
                        <td>
                            <a href="{% url 'officer_detail' officer.pk %}"
                               class="text-green-500 hover:text-green-600 underline mx-2">
                                Xem
                            </a>
                            <span class="px-2"></span>
                            <a href="{% url 'officer_delete' officer.pk %}"
                               class="text-red-600 hover:text-red-700 underline mx-2">
                                Xoá
                            </a>
                        </td>
                    </tr>
                </tbody>
            {% endfor %}

        </table>
    </div>

    <div id="searchOfficer"
         class="w-2/5">
        <form method="GET"
              action="{% url 'officer_list' %}">
            <div class="flex mx-16 space-x-2">
                <!-- Search by name -->
                <div class="mt-9">
                    <input type="text"
                           name="birth_name"
                           placeholder="Tìm theo tên"
                           value="{{ birth_name|default_if_none:'' }}"
                           class="rounded-lg input-sm" />
                </div>

                <!-- Search by id_ca -->
                <div class="mt-9">
                    <input type="text"
                           name="id_ca"
                           placeholder="Tìm theo số hiệu"
                           value="{{ id_ca|default_if_none:'' }}"
                           class="rounded-lg input-sm" />
                </div>

                <div class="tooltip tooltip-top mt-7"
                     data-tip="Lọc">
                    <button type="submit"
                            class="btn btn-md btn-square btn-ghost">
                        <img src="{% static 'src/filter.png' %}"
                             alt="Filter Icon"
                             class="w-9 h-9" />
                    </button>
                </div>

                <div class="flex-none tooltip tooltip-top mt-10"
                     data-tip="Xoá bộ lọc">

                    {% if request.GET %}

                        <a href="{% url 'officer_list' %}">
                            <img src="{% static 'src/delete-icon.png' %}"
                                 alt="Delete icon"
                                 class="w-6 h-6" />
                        </a>

                    {% endif %}


                </div>
            </div>

            <div class="flex mx-16 space-x-2 mt-1">

                <!-- Search by birth_year -->
                <div class="filter-container mt-2">
                    <input type="text"
                           name="birth_year"
                           placeholder="Tìm theo năm sinh"
                           value="{{ birth_year|default_if_none:'' }}"
                           class="rounded-lg input-sm filter-input" />
                           <span class="trash-icon" onclick="removeFilter(this)">
                            <img src="{% static 'svg/trash-icon.svg' %}" alt="Trash Icon" width="20" height="20" />
                        </span>
                </div>
            
                <!-- Search by current_residence -->
                <div class="">
                    <input type="text"
                           name="current_residence"
                           placeholder="Tìm theo chỗ ở hiện nay"
                           value="{{ current_residence|default_if_none:'' }}"
                           class="rounded-lg input-sm" />

                </div>

            </div>

            <div class="filter-container">
                <label for="position">Chức vụ:</label>
                
                <div class="select-wrapper">
                    <!-- Dropdown select -->
                    <select name="position" data-filter-name="position">
                        <option value="">Tất cả</option>
                        {% for p in position %}
                            <option value="{{ p }}" {% if request.GET.position == p %}selected{% endif %}>{{ p }}</option>
                        {% endfor %}
                    </select>
                </div>
            
                <span class="trash-icon" onclick="removeFilter(this)">
                    <img src="{% static 'svg/trash-icon.svg' %}" alt="Trash Icon" width="20" height="20" />
                </span>
            </div>

        </form>
    </div>
</div>

<!-- Export Form -->
<div id="exportForm"
     style="display: none">
    <form method="post"
          action="{% url 'export_officers_data' %}"
          onsubmit="return validateSelection()">
        {% csrf_token %}
        <h3 class="mb-10 mt-5 text-3xl font-semibold text-center">
            Chọn cán bộ và thông tin cần trích xuất
        </h3>

        <div class="container mx-auto">
            <table class="min-w-full border border-gray-300">
                <thead>
                    <tr>
                        <th class="px-4 py-4 border border-gray-300 text-center bg-base-200"> Chọn cán bộ </th>
                        <th class="px-4 py-4 border border-gray-300 text-center bg-base-200"> Chọn thông tin </th>
                        <th class="px-4 py-4 border border-gray-300 text-center bg-base-200"> Chọn bảng liên quan </th>
                    </tr>
                </thead>

                <tbody>
                    <tr>
                        <td class="border border-gray-300 p-4 pl-8 h-20 overflow-y-auto align-top">
                            <div class="space-y-3">
                                <label class="font-semibold">
                                    <input type="checkbox"
                                           id="select-all-officers" />
                                    Chọn tất cả
                                </label>
                                <ol class="pl-10">

                                    {% for officer in officers %}
                                        <input type="checkbox"
                                               name="officers"
                                               value="{{ officer.pk }}"
                                               id="officer_{{ officer.pk }}" />
                                        <label for="officer_{{ officer.pk }}">
                                            {{ officer.birth_name }} - {{ officer.birth_year }} - {{ officer.work_unit }}
                                        </label>
                                        <br />
                                    {% endfor %}

                                </ol>
                            </div>
                        </td>
                        <td class="border border-gray-300 p-4 h-20 overflow-y-auto">
                            <div class="space-y-3">
                                <label class="font-semibold">
                                    <input type="checkbox"
                                           id="select-all-fields" />
                                    Chọn tất cả
                                </label>
                                <ul class="pl-10">
                                    {{ form.fields }}
                                </ul>
                            </div>
                        </td>
                        <td class="border border-gray-300 p-4 h-20 overflow-y-autoauto align-top">
                            <div class="space-y-3">
                                <label class="font-semibold">
                                    <input type="checkbox"
                                           id="select-all-related-tables" />
                                    Chọn tất cả
                                </label>
                                <ul class="pl-10">
                                    {{ form.related_tables }}
                                </ul>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="flex justify-center">
            <button type="submit"
                    name="export"
                    class="btn text-lg mb-10 mt-5 rounded-lg w-2/5 space-x-2">
                <span>Xuất dữ liệu</span>
                <img src="{% static 'src/export-file.png' %}"
                     alt="Export File"
                     class="w-5 h-5" />

            </button>
        </div>
    </form>
</div>

<script>
    function toggleView() {
        var isChecked = document.getElementById('toggleExportForm').checked;
        var officerList = document.getElementById('officerList');
        var exportForm = document.getElementById('exportForm');
        var searchOfficer = document.getElementById('searchOfficer');

        if (isChecked) {
            officerList.style.display = 'none';
            searchOfficer.style.display = 'none';
            exportForm.style.display = 'block';
        } else {
            officerList.style.display = 'block';
            searchOfficer.style.display = 'block';
            exportForm.style.display = 'none';
        }
    }
    document.getElementById('select-all-officers').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('input[name="officers"]');
        checkboxes.forEach((checkbox) => {
            checkbox.checked = this.checked;
        });
    });
    document.getElementById('select-all-fields').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('input[name="{{ form.fields.name }}"]');
        checkboxes.forEach((checkbox) => {
            checkbox.checked = this.checked;
        });
    });

    document.getElementById('select-all-related-tables').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('input[name="{{ form.related_tables.name }}"]');
        checkboxes.forEach((checkbox) => {
            checkbox.checked = this.checked;
        });
    });

    function validateSelection() {
        // Get all officer checkboxes
        const officerCheckboxes = document.querySelectorAll('input[name="officers"]');
        const isAnyOfficerSelected = Array.from(officerCheckboxes).some(checkbox => checkbox.checked);
    
        // Get all field checkboxes in the "Chọn thông tin" section
        const fieldCheckboxes = document.querySelectorAll('input[name="{{ form.fields.name }}"]');
        const isAnyFieldSelected = Array.from(fieldCheckboxes).some(checkbox => checkbox.checked);
    
        // Determine which warning to show based on selection
        if (!isAnyOfficerSelected && !isAnyFieldSelected) {
            showWarningModal("Vui lòng chọn ít nhất một cán bộ và một trường thông tin để xuất dữ liệu!");
            return false; 
        } else if (!isAnyOfficerSelected) {
            showWarningModal("Vui lòng chọn ít nhất một cán bộ để xuất dữ liệu!");
            return false; 
        } else if (!isAnyFieldSelected) {
            showWarningModal("Vui lòng chọn ít nhất một trường thông tin để xuất dữ liệu!");
            return false; 
        }
    
        return true; // Allow form submission if all validations pass
    }
    
    // Show the warning modal with a custom message
    function showWarningModal(message) {
        const warningModal = document.getElementById('warningModal');
        warningModal.querySelector('p').innerText = message; // Set custom message
        warningModal.style.display = 'block';
    }
    
    // Close the warning modal
    function closeWarningModal() {
        document.getElementById('warningModal').style.display = 'none';
    }
    
    function removeFilter(closeButton) {
        const filterContainer = closeButton.parentElement;
    
        // Check for an input or select element within the filter container
        const filterElement = filterContainer.querySelector('input, select');
    
        if (filterElement) {
            const filterName = filterElement.getAttribute('name');
    
            // Hide the filter container
            filterContainer.style.display = 'none';
    
            // Store the hidden state in 
            sessionStorage.setItem(`filter_${filterName}_hidden`, 'true');
        } else {
            console.error("Filter element not found within filter container");
        }
    }

    function restoreFilterVisibility() {
        document.querySelectorAll('.filter-container').forEach(container => {
            const filterElement = container.querySelector('input, select');
            
            if (filterElement) {
                const filterName = filterElement.getAttribute('name');
                const isHidden = sessionStorage.getItem(`filter_${filterName}_hidden`) === 'true';
                
                // Hide the filter container if it was marked as hidden
                if (isHidden) {
                    container.style.display = 'none';
                }
            }
        });
    }
    
    // Call the restore function on page load
    document.addEventListener('DOMContentLoaded', restoreFilterVisibility);

</script>
