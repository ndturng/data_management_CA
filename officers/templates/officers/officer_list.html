{% load static tailwind_tags %}
{% tailwind_css %}

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0" />
    <title>Officer Information System</title>

    <!-- Link to local Font Awesome CSS -->
    <link rel="stylesheet"
          href="{% static 'fonts/font-awesome/css/all.min.css' %}" />

    <!-- Link to compiled Tailwind CSS -->
    <link rel="stylesheet"
          href="{% static 'css/dist/styles.css' %}" />
</head>

<body class="bg-gray-50">
    <!-- Navigation Bar -->
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <div class="flex flex-col items-center md:items-start">
                <h1 class="text-2xl font-bold">CÔNG AN THỊ XÃ ĐÔNG HOÀ</h1>
                <h2 class="text-xl font-semibold">THÔNG TIN CÁN BỘ</h2>
            </div>
            <div class="flex flex-wrap gap-3 justify-center md:justify-end">
                <a href="{% url 'officer_create' %}"
                   class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-50 transition">
                    <i class="fas fa-plus mr-2"></i>Add Officer
                </a>
                <button class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-50 transition"
                        id="toggleExportForm"
                        onclick="toggleView()">
                    <i class="fas fa-file-export mr-2"></i>Export Data
                </button>
                <a href="{% url 'excel_upload' %}"
                   class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-50 transition">
                    <i class="fas fa-file-upload mr-2"></i>Upload Excel
                </a>
                <a href="{% url 'delete_all_officers' %}"
                   class="bg-white text-red-600 px-4 py-2 rounded-lg hover:bg-red-50 transition">
                    <i class="fas fa-trash-alt mr-2"></i>Delete All
                </a>
                <button class="bg-white text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>Log Out
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 flex flex-col lg:flex-row gap-6">
        <!-- Left section (Officer List) -->
        <div class="lg:w-3/4 h-[calc(100vh-130px)]">
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="overflow-x-auto overflow-y-auto h-full">
                    <table class="min-w-full divide-y divide-gray-200">

                        {% for officer in officers %}
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-2 whitespace-nowrap max-w-25 text-center">
                                        {{ forloop.counter }}
                                    </td>
                                    <td class="px-2 py-2 whitespace-nowrap max-w-150">{{ officer.birth_name }}</td>
                                    <td class="px-2 py-2 whitespace-nowrap">{{ officer.birth_year }}</td>
                                    <td class="px-2 py-2 whitespace-nowrap">{{ officer.military_rank }}</td>
                                    <td class="px-2 py-2 whitespace-nowrap">{{ officer.position }}</td>
                                    <td class="px-2 py-2 whitespace-nowrap">{{ officer.work_unit }}</td>
                                    <td class="px-2 py-2 whitespace-nowrap">
                                        <a href="{% url 'officer_detail' officer.pk %}"
                                           class="text-blue-600 hover:text-blue-800 mr-2">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'officer_delete' officer.pk %}"
                                           class="text-red-600 hover:text-red-800">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                        {% endfor %}

                    </table>
                </div>
            </div>
            
        </div>

        <!-- Right Section (Filter Options) -->
        <div class="lg:w-1/4">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-3 items-center text-center">
                    Filter Options
                </h2>
                <div class="flex justify-between items-center mb-4 gap-2">
                    <button class="text-blue-600 hover:text-blue-800 text-sm font-normal flex items-center">
                        <i class="fas fa-plus mr-1"></i>Add Filters
                    </button>
                    <button class="text-red-600 hover:text-red-800 text-sm font-normal flex items-center">
                        <i class="fas fa-times mr-1"></i>Remove Filters
                    </button>
                </div>
                <div class="flex gap-2 mb-4">
                    <button type="submit"
                            class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                        Apply Filters
                    </button>
                    <button type="button"
                            class="flex-1 bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                        Reset All
                    </button>
                </div>
                <form>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Department</label>
                            <select class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option>All Departments</option>
                                <option>IT Department</option>
                                <option>HR Department</option>
                                <option>Finance Department</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Rank</label>
                            <select class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option>All Ranks</option>
                                <option>Senior Officer</option>
                                <option>Junior Officer</option>
                                <option>Chief Officer</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Search</label>
                            <input type="text"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                   placeholder="Search officers..." />
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal for Add Officer -->
    <div id="addModal"
         class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex justify-center items-center">
        <!-- Modal content -->
        <div class="bg-white p-8 rounded-lg w-96">
            <h3 class="text-xl font-semibold mb-4">Add New Officer</h3>
            <form>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                               placeholder="Officer's name" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Rank</label>
                        <input type="text"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                               placeholder="Officer's rank" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Department</label>
                        <input type="text"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                               placeholder="Officer's department" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Contact</label>
                        <input type="text"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                               placeholder="Officer's contact" />
                    </div>
                    <div class="flex justify-end gap-4 mt-4">
                        <button type="button"
                                class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md">
                            Cancel
                        </button>
                        <button type="submit"
                                class="bg-blue-600 text-white px-4 py-2 rounded-md">
                            Save
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</body>

<!-- Warning Message Modal -->
<div id="warningModal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
     
    <div class="bg-white p-6 rounded-lg shadow-lg w-96 text-center">
        <p class="text-red-600 text-center mb-4 font-semibold text-lg">
            CHÚ Ý
        </p>
        <p class="text-center" id="warningText"></p>
        

        <button onclick="closeWarningModal()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg mt-4">
                       OK
        </button>
    </div>
</div>

<!-- Export Data Modal -->
<div id="exportModal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"> 
    <div class="bg-white rounded-lg p-6 shadow-lg w-full max-w-7xl mx-4 overflow-hidden">
        
        <div class="flex justify-between items-center mb-6 p-2">
            <h2 class="text-2xl font-semibold">Export Data</h2>
            <button type="button"
                    class="text-red-600 hover:text-red-800"
                    onclick="closeExportForm()">
                <svg class="w-6 h-6"
                     fill="none"
                     stroke="currentColor"
                     viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                    </svg>
            </button>
        </div>
        
        <div class="bg-gray-50 p-6 rounded-lg">
            <form class="space-y-6"
                  method="post"
                  action="{% url 'export_officers_data' %}"
                  onsubmit="return validateSelection()">
                {% csrf_token %}
                <div class="flex gap-6">

                    <!-- Select Officers -->
                    <div class="space-y-2 w-1/2">
                        <label class="block text-sm font-medium text-gray-700">Select Officers</label>
                        
                        <div class="space-y-2 h-96 overflow-y-auto border rounded-lg p-3 bg-white shadow-sm">

                            <label class="flex items-center space-x-2 hover:bg-gray-200 p-1 rounded">
                                <input type="checkbox"
                                    id="select-all-officers"
                                    class="select-all border-black" />
                                <span>Select All Officers</span>
                            </label>

                            {% for officer in officers %}
                                <label class="flex items-center space-x-2 hover:bg-gray-200 p-1 rounded">
                                    <input type="checkbox"
                                        name="officers"
                                        value="{{ officer.pk }}"
                                        class="officer-checkbox border-black" />
                                    <span>{{ officer.birth_name }} - {{ officer.birth_year }} - {{ officer.work_unit }}</span>
                                </label>
                            {% endfor %}

                        </div>
                    </div>

                    <!-- Select Fields -->
                    <div class="space-y-2 w-1/4">
                        <label class="block text-sm font-medium text-gray-700">Select Fields</label>

                        <div class="space-y-2 h-96 overflow-y-auto border rounded-lg p-3 bg-white shadow-sm">
                            <label class="flex items-center space-x-2 hover:bg-gray-200 p-1 rounded">
                                <input type="checkbox"
                                    id="select-all-fields"
                                    class="border-black select-all" />
                                <span>Select All Fields</span>
                            </label>

                            {% for value, label in form.fields.model_fields.choices %}
                                <label class="flex items-center space-x-2 hover:bg-gray-200 p-1 rounded">
                                    <input type="checkbox"
                                        name="model_fields"
                                        value="{{ value }}"
                                        class="field-checkbox border-black" />
                                    <span>{{ label }}</span>
                                </label>
                            {% endfor %}

                        </div>
                    </div>

                    <!-- Related Tables -->
                    <div class="space-y-2 w-1/4">
                        <label class="block text-sm font-medium text-gray-700">Related Tables</label>

                        <div class="space-y-2 h-96 overflow-y-auto border rounded-lg p-3 bg-white shadow-sm">
                            <label class="flex items-center space-x-2 hover:bg-gray-200 p-1 rounded">
                                <input type="checkbox"
                                    id="select-all-related-tables"
                                    class="select-all" />
                                <span>Select All Related Tables</span>
                            </label>

                            {% for value, label in form.fields.related_tables.choices %}
                                <label class="flex items-center space-x-2 hover:bg-gray-200 p-1 rounded">
                                    <input type="checkbox"
                                        name="related_tables"
                                        value="{{ value }}"
                                        class="related-table-checkbox border-black" />
                                    <span>{{ label }}</span>
                                </label>
                            {% endfor %}

                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 mt-8">
                    <button onclick="closeExportForm()"
                            class="px-6 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit"
                            name="export"
                            class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                        Export
                    </button>
                </div>
            </form>
        </div>

    </div>
</div>

<script>
    // JavaScript to control the "Select All" functionality
    document.addEventListener("DOMContentLoaded", function() {
        // General function to handle "Select All" checkbox functionality
        function setupSelectAll(selectAllId, checkboxesClass) {
            const selectAll = document.getElementById(selectAllId);
            const checkboxes = document.querySelectorAll(checkboxesClass);
            selectAll.addEventListener('change', function() {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectAll.checked;
                });
            });
        }

        // Setup Select All for each section
        setupSelectAll('select-all-officers', '.officer-checkbox');
        setupSelectAll('select-all-fields', '.field-checkbox');
        setupSelectAll('select-all-related-tables', '.related-table-checkbox');
    });
    
    // Function to apply selected filters from the modal
    function applySelectedFilters() {
        // Get all selected checkboxes in the modal
        const selectedFilters = Array.from(
            document.querySelectorAll(".filter-checkbox:checked")
        ).map((checkbox) => checkbox.value);

        // Show the selected filters on the main page
        selectedFilters.forEach((filterName) => {
            const filterElement = document.querySelector(
                `.filter-container[data-filter-name="${filterName}"]`
            );

            if (filterElement) {
                filterElement.style.display = "flex"; // Show the filter
                sessionStorage.setItem(`filter_${filterName}_visible`, "true"); // Save visibility state
            } 
        });

        // Check if at least one selected filter has a value saved in sessionStorage, then reload the page
        const hasSavedValue = selectedFilters.some((filterName) => {
            const savedValue = sessionStorage.getItem(`filter_${filterName}_value`);
            // if savedValue is null or empty string, return false
            return savedValue && savedValue.trim();
        });
        
        if (hasSavedValue) {
            document.getElementById("filterForm").submit();
        }

        // Get all the unselected checkboxes in the modal
        const unselectedFilters = Array.from(
            document.querySelectorAll(".filter-checkbox:not(:checked)")
        ).map((checkbox) => checkbox.value);

        // Hide the unselected filters on the main page
        unselectedFilters.forEach((filterName) => {
            const filterElement = document.querySelector(
                `.filter-container[data-filter-name="${filterName}"]`
            );
            if (filterElement) {
                filterElement.style.display = "none"; // Hide the filter
                sessionStorage.setItem(`filter_${filterName}_visible`, "false"); // Save hidden state
            }
        });

        // Reset hidden filters value
        unselectedFilters.forEach((filterName) => {
            const filterElement = document.querySelector(
                `.filter-container[data-filter-name="${filterName}"]`
            );
            if (filterElement) {
                filterElement.querySelector("input, select").value = ""; 
            }
        });

        const hasSavedValue_unchecked = unselectedFilters.some((filterName) => {
            const savedValue = sessionStorage.getItem(`filter_${filterName}_value`);
            // if savedValue is null or empty string, return false
            return savedValue && savedValue.trim();
        });

        if (hasSavedValue_unchecked) {
            document.getElementById("filterForm").submit();
        }

        // Close the modal after applying
        closeFilterModal();
    }

    // Restore the checkbox state in the modal
    function restoreModalCheckboxState() {
        document.querySelectorAll(".filter-checkbox").forEach((checkbox) => {
            const filterName = checkbox.value;
            const isVisible = sessionStorage.getItem(
                `filter_${filterName}_visible`
            ) === "true";
            checkbox.checked = isVisible; // Check the checkbox if the filter is visible
        });
    }


    // Restore value of visible filters from sessionStorage
    function restoreFilterValues() {
        document.querySelectorAll(".filter-container input, .filter-container select").forEach(input => {
            const filterName = input.getAttribute("name");
            const savedValue = sessionStorage.getItem(`filter_${filterName}_value`);
            const isVisible = sessionStorage.getItem(`filter_${filterName}_visible`) === "true";
            
            if (savedValue && isVisible) {
                input.value = savedValue;
            }
        });
    }

    // When click on Reset Filter Button
    function resetFilter() {
        // Clear all filter values and their values in sessionStorage
        document.querySelectorAll(".filter-container input, select").forEach(filterInput => {
            filterInput.value = "";
            const filterName = filterInput.closest(".filter-container").getAttribute("data-filter-name");
            sessionStorage.removeItem(`filter_${filterName}_value`);

        });


    }

    // When click on Delete All Filter Button
    function deleteFilters() {
        sessionStorage.clear();
    }
        
    // When click on "Lọc" Button
    function applyFilter() {
        // Save filter values to sessionStorage if that filter is visible
        document.querySelectorAll(".filter-container").forEach(container => {
            const filterName = container.getAttribute("data-filter-name");
            const filterInput = container.querySelector("input, select");
            if (filterInput && container.style.display !== "none") {
                sessionStorage.setItem(`filter_${filterName}_value`, filterInput.value);
            }
        });
    }
        

    document.addEventListener("DOMContentLoaded", () => {
        // Restore filter visibility and modal state on page load
        restoreFilterVisibility();
        restoreModalFilterState();
        restoreFilterValues();
        restoreModalCheckboxState();

        let hasFilters = false;
        // Check if there are any filter visible and its value was saved in sessionStorage
        document.querySelectorAll(".filter-container").forEach(container => {
            const filterName = container.getAttribute("data-filter-name");
            const isVisible = sessionStorage.getItem(`filter_${filterName}_visible`) === "true";
            const hasSavedValue = sessionStorage.getItem(`filter_${filterName}_value`);
            if (isVisible && hasSavedValue) {
                hasFilters = true;
                // Break the loop if at least one filter has a saved value
                return;
            }
        });
        const filtersAlreadyApplied = sessionStorage.getItem("filters_applied");

        if (hasFilters && !filtersAlreadyApplied) {
            // Apply filters if there are saved values and filters are not already applied
            document.getElementById("filterForm").submit();
            sessionStorage.setItem("filters_applied", "true");
        } else {
            // Clear the sessionStorage key if there are no saved values
            sessionStorage.removeItem("filters_applied");
        }
    });
    
    // Restore filter visibility from sessionStorage
    function restoreFilterVisibility() {
        document.querySelectorAll(".filter-container").forEach(container => {
            const filterName = container.getAttribute("data-filter-name");
            const isVisible = sessionStorage.getItem(`filter_${filterName}_visible`) === "true";
            container.style.display = isVisible ? "flex" : "none"; // Restore visibility
        });
    }
    
    // Show a filter when selected in the modal
    function showFilter(filterName) {
        const filterElement = document.querySelector(`.filter-container[data-filter-name="${filterName}"]`);
        if (filterElement) {
            filterElement.style.display = "flex"; // Show the filter
            sessionStorage.setItem(`filter_${filterName}_visible`, "true"); // Save visibility state
            updateModalFilterState(filterName, true); // Mark as selected in the modal
        }
        closeFilterModal(); // Close the modal after selection
    }
    
    // Hide a filter and update sessionStorage
    function removeFilter(closeButton) {
        const filterContainer = closeButton.parentElement;
        const filterName = filterContainer.getAttribute("data-filter-name");

        filterContainer.style.display = "none"; // Hide the filter
        sessionStorage.setItem(`filter_${filterName}_visible`, "false"); // Save hidden state

        // Check if the value of the filter not empty
        if (filterContainer.querySelector("input, select").value) {
            // Clear the saved value for the filter
            sessionStorage.removeItem(`filter_${filterName}_value`);

            // Reset the filter value
            filterContainer.querySelector("input, select").value = "";

            // Reload the page to apply the filters
            document.getElementById("filterForm").submit();

        }
        // Uncheck the corresponding checkbox in the modal
        const modalCheckbox = document.querySelector(
            `.filter-checkbox[value="${filterName}"]`
        );
        if (modalCheckbox) {
            modalCheckbox.checked = false; // Uncheck the checkbox
        }

        updateModalFilterState(filterName, false); // Unmark as active in the modal
        
    }
    
    // Restore the selected state of filters in the modal
    function restoreModalFilterState() {
        document.querySelectorAll(".filter-option").forEach(option => {
            const filterName = option.getAttribute("onclick").match(/'([^']+)'/)[1];
            const isVisible = sessionStorage.getItem(`filter_${filterName}_visible`) === "true";
            if (isVisible) {
                option.classList.add("active"); // Mark as active
            } else {
                option.classList.remove("active"); // Remove active state
            }
        });
    }
    
    // Update the selected state of a filter in the modal
    function updateModalFilterState(filterName, isVisible) {
        const filterOption = document.querySelector(`.filter-option[onclick*="'${filterName}'"]`);
        if (filterOption) {
            if (isVisible) {
                filterOption.classList.add("active"); // Mark as active
            } else {
                filterOption.classList.remove("active"); // Unmark as active
            }
        }
    }
    
    // Open and close modal functions
    function openFilterModal() {
        event.preventDefault();
        const modal = document.getElementById("filterModal");
        modal.style.display = "flex";
    }
    
    function closeFilterModal() {
        const modal = document.getElementById("filterModal");
        modal.style.display = "none";
    }

    // Show export form
    function toggleView() {
        event.preventDefault();
        document.getElementById("exportModal").classList.toggle("hidden");     
    }

    function closeExportForm() {
        event.preventDefault();
        document.getElementById("exportModal").classList.add("hidden");
    }

    // Validate selection for export
    function validateSelection() {
        const officerCheckboxes = document.querySelectorAll('input[name="officers"]');
        const isAnyOfficerSelected = Array.from(officerCheckboxes).some(checkbox => checkbox.checked);
    
        const fieldCheckboxes = document.querySelectorAll('input[name="model_fields"]');
        const isAnyFieldSelected = Array.from(fieldCheckboxes).some(checkbox => checkbox.checked);
    
        if (!isAnyOfficerSelected && !isAnyFieldSelected) {
            showWarningModal("Vui lòng chọn ít nhất một CÁN BỘ và một THÔNG TIN để xuất dữ liệu!");
            return false;
        } else if (!isAnyOfficerSelected) {
            showWarningModal("Vui lòng chọn ít nhất một CÁN BỘ để xuất dữ liệu!");
            return false;
        } else if (!isAnyFieldSelected) {
            showWarningModal("Vui lòng chọn ít nhất một THÔNG TIN để xuất dữ liệu!");
            return false;
        }
    
        return true; // All validations pass
    }
    
    // Show and close warning modal
    function showWarningModal(message) {
        const warningModal = document.getElementById("warningModal");
        const warningText = document.getElementById("warningText");
        if (warningText) {
            warningText.innerText = message; // Set custom message
        }
        warningModal.classList.remove("hidden"); // Show modal
    }
    
    function closeWarningModal() {
        const warningModal = document.getElementById("warningModal");
        warningModal.style.display = "none"; // Hide modal
    }
    
</script>
