{% load static tailwind_tags %}

<div class="navbar bg-base-200 mb-10 shadow-inner drop-shadow-md">
    {% tailwind_css %}
    <div class="flex-1">
        <h2 class="font-semibold text-2xl ml-20">THÔNG TIN CÁN BỘ</h2>
    </div>
    <div class="flex-none">
        <div class="flex-none tooltip tooltip-bottom"
             data-tip="Tìm kiếm">
            <button class="btn btn-md btn-circle btn-ghost">
                <img src="{% static 'src/search.png' %}"
                     alt="Search Icon"
                     class="w-5 h-5" />
            </button>
        </div>
        <a href="{% url 'officer_create' %}"
           class="btn btn-ghost rounded-md">
            <span class="text-lg">Thêm mới cán bộ</span>
            <img src="{% static 'src/add-user.png' %}"
                 alt="Add user"
                 class="w-5 h-5" />
        </a>

        <a href="{% url 'excel_upload' %}"
           class="btn btn-ghost rounded-md">
            <span class="text-lg">Tải lên từ Excel</span>
            <img src="{% static 'src/upload.png' %}"
                 alt="Upload icon"
                 class="w-5 h-5" />
        </a>

        {% if officers %}
            <a href="{% url 'delete_all_officers' %}"
               class="btn btn-ghost rounded-md text-red-600 text-lg">Xoá tất cả</a>
        {% endif %}

        <button>

            {% if user.is_authenticated %}
                <!-- <p>Chào mừng, {{ user.username }}! </p> -->
                <form method="POST"
                      action="{% url 'logout' %}">
                    {% csrf_token %}
                    <button type="submit"
                            class="btn btn-ghost rounded-md text-lg">
                        Đăng xuất
                    </button>
                </form>
            {% else %}
                <a href="{% url 'login' %}">Đăng nhập</a>
            {% endif %}

        </button>
    </div>
</div>

<!-- Warning Message Modal (initially hidden) -->
<div id="warningModal"
     style="display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #f8d7da;
            color: #721c24;
            padding: 20px;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            z-index: 1000">
    <div style="text-align: center;
                margin-top: 10px">

        <button onclick="closeWarningModal()"
                style="background-color: #721c24;
                       color: white;
                       border: none;
                       padding: 5px 10px;
                       cursor: pointer;
                       border-radius: 3px">OK</button>
    </div>
</div>

<!-- Display messages -->

{% if messages %}

    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mb-10">{{ message }}</div>
    {% endfor %}

{% endif %}


<!-- Checkbox to toggle between officer list and export form -->
<label class="font-semibold ml-10 text-lg">
    <input type="checkbox"
           id="toggleExportForm"
           onclick="toggleView()" />
    Xuất dữ liệu
</label>

<div class="flex divide-x">
    <!-- Officer List and Filter Form -->
    <div id="officerList"
         class="mx-20 w-3/5">
        <table class="table">
            <thead>
                <tr>
                    <th></th>
                </tr>
            </thead>

            {% for officer in officers %}
                <tbody class="mx-10 text-lg">
                    <tr>
                        <th>1</th>
                        <td>{{ officer.birth_name }}</td>
                        <td>{{ officer.birth_year }}</td>
                        <td>{{ officer.work_unit }}</td>
                        <td>
                            <a href="{% url 'officer_detail' officer.pk %}"
                               class="text-green-500 hover:text-green-600 underline mx-2">
                                Xem
                            </a>
                            <span class="px-2"></span>
                            <a href="{% url 'officer_delete' officer.pk %}"
                               class="text-red-600 hover:text-red-700 underline mx-2">
                                Xoá
                            </a>
                        </td>
                    </tr>
                </tbody>
            {% endfor %}

        </table>
    </div>

    <div id="searchOfficer"
         class="w-2/5">
        <form id="filterForm"
              method="GET"
              action="{% url 'officer_list' %}">
            <div class="flex mx-16 space-x-2">
                <!-- Search by name -->
                <div class="mt-9">
                    <input type="text"
                           name="birth_name"
                           placeholder="Tìm theo tên"
                           value="{{ birth_name|default_if_none:'' }}"
                           class="rounded-lg input-sm" />
                </div>

                <!-- Search by id_ca -->
                <div class="mt-9">
                    <input type="text"
                           name="id_ca"
                           placeholder="Tìm theo số hiệu"
                           value="{{ id_ca|default_if_none:'' }}"
                           class="rounded-lg input-sm" />
                </div>

                <div class="tooltip tooltip-top mt-7"
                     data-tip="Lọc">
                    <button type="submit"
                            class="btn btn-md btn-square btn-ghost"
                            onclick="applyFilter()">
                        <img src="{% static 'src/filter.png' %}"
                             alt="Filter Icon"
                             class="w-9 h-9" />
                    </button>
                </div>

                <!-- Reset all filter value -->
                <div class="tooltip tooltip-top mt-7"
                     data-tip="Reset bộ lọc"
                     onclick="resetFilter()">
                    <a href="{% url 'officer_list' %}">
                        <img src="{% static 'src/reset_icon.png' %}"
                             alt="Delete icon"
                             class="w-6 h-6" />
                    </a>
                </div>


                <div class="flex-none tooltip tooltip-top mt-10"
                     data-tip="Xoá bộ lọc"
                     onclick="deleteFilters()">
                    <a href="{% url 'officer_list' %}">
                        <img src="{% static 'src/delete-icon.png' %}"
                             alt="Delete icon"
                             class="w-6 h-6" />
                    </a>

                </div>

            </div>

            <div class="flex mx-16 space-x-2 mt-1">

                <!-- Search by birth_year -->
                <div class="filter-container"
                     data-filter-name="birth_year">
                    <input type="text"
                           name="birth_year"
                           placeholder="Tìm theo năm sinh" />
                    <span class="trash-icon"
                          onclick="removeFilter(this)">
                        <img src="{% static 'svg/trash-icon.svg' %}"
                             alt="Trash Icon"
                             width="20"
                             height="20" />
                    </span>
                </div>
            </div>

            <div class="filter-container"
                 data-filter-name="position">
                <label for="position">Chức vụ:</label>
                <div class="select-wrapper">
                    <select name="position">
                        <option value="">Tất cả</option>

                        {% for p in position %}
                            <option value="{{ p }}" 
                                {% if request.GET.position == p %}selected{% endif %}
                                >{{ p }}</option>
                        {% endfor %}

                    </select>
                </div>
                <span class="trash-icon"
                      onclick="removeFilter(this)">
                    <img src="{% static 'svg/trash-icon.svg' %}"
                         alt="Trash Icon"
                         width="20"
                         height="20" />
                </span>
            </div>

        </form>
        <!-- "Thêm bộ lọc" Button -->
        <button class="add-filter-button"
                onclick="openFilterModal()">+ Thêm bộ lọc</button>

        <!-- Filter Selection Modal -->
        <div id="filterModal"
             class="modal-overlay"
             style="display: none">
            <div class="modal-content">
                <span class="close-modal"
                      onclick="closeFilterModal()">&times;</span>
                <h3 class="modal-title">Chọn các bộ lọc</h3>

                <!-- Filter Options -->
                <div class="filter-options">
                    <label>
                        <input type="checkbox"
                               class="filter-checkbox"
                               value="birth_year" />
                        Tìm theo năm sinh
                    </label>
                    <label>
                        <input type="checkbox"
                               class="filter-checkbox"
                               value="position" />
                        Chức vụ
                    </label>
                </div>

                <!-- Apply Filters Button -->
                <button class="btn btn-primary mt-5"
                        onclick="applySelectedFilters()">Áp dụng</button>
            </div>
        </div>
    </div>
</div>


<!-- Export Form -->
<div id="exportForm"
     style="display: none">
    <form method="post"
          action="{% url 'export_officers_data' %}"
          onsubmit="return validateSelection()">
        {% csrf_token %}
        <h3 class="mb-10 mt-5 text-3xl font-semibold text-center">
            Chọn cán bộ và thông tin cần trích xuất
        </h3>

        <div class="container mx-auto">
            <table class="min-w-full border border-gray-300">
                <thead>
                    <tr>
                        <th class="px-4 py-4 border border-gray-300 text-center bg-base-200">
                            Chọn cán bộ
                        </th>
                        <th class="px-4 py-4 border border-gray-300 text-center bg-base-200">
                            Chọn thông tin
                        </th>
                        <th class="px-4 py-4 border border-gray-300 text-center bg-base-200">
                            Chọn bảng liên quan
                        </th>
                    </tr>
                </thead>

                <tbody>
                    <tr>
                        <td class="border border-gray-300 p-4 pl-8 h-20 overflow-y-auto align-top">
                            <div class="space-y-3">
                                <label class="font-semibold">
                                    <input type="checkbox"
                                           id="select-all-officers" />
                                    Chọn tất cả
                                </label>
                                <ol class="pl-10">

                                    {% for officer in officers %}
                                        <input type="checkbox"
                                               name="officers"
                                               value="{{ officer.pk }}"
                                               id="officer_{{ officer.pk }}" />
                                        <label for="officer_{{ officer.pk }}">
                                            {{ officer.birth_name }} - {{ officer.birth_year }} - {{ officer.work_unit }}
                                        </label>
                                        <br />
                                    {% endfor %}

                                </ol>
                            </div>
                        </td>
                        <td class="border border-gray-300 p-4 h-20 overflow-y-auto">
                            <div class="space-y-3">
                                <label class="font-semibold">
                                    <input type="checkbox"
                                           id="select-all-fields" />
                                    Chọn tất cả
                                </label>
                                <ul class="pl-10">
                                    {{ form.fields }}
                                </ul>
                            </div>
                        </td>
                        <td class="border border-gray-300 p-4 h-20 overflow-y-autoauto align-top">
                            <div class="space-y-3">
                                <label class="font-semibold">
                                    <input type="checkbox"
                                           id="select-all-related-tables" />
                                    Chọn tất cả
                                </label>
                                <ul class="pl-10">
                                    {{ form.related_tables }}
                                </ul>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="flex justify-center">
            <button type="submit"
                    name="export"
                    class="btn text-lg mb-10 mt-5 rounded-lg w-2/5 space-x-2">
                <span>Xuất dữ liệu</span>
                <img src="{% static 'src/export-file.png' %}"
                     alt="Export File"
                     class="w-5 h-5" />

            </button>
        </div>
    </form>
</div>

<script>
    // Function to apply selected filters from the modal
    function applySelectedFilters() {
        // Get all selected checkboxes in the modal
        const selectedFilters = Array.from(
            document.querySelectorAll(".filter-checkbox:checked")
        ).map((checkbox) => checkbox.value);

        // Show the selected filters on the main page
        selectedFilters.forEach((filterName) => {
            const filterElement = document.querySelector(
                `.filter-container[data-filter-name="${filterName}"]`
            );

            if (filterElement) {
                filterElement.style.display = "flex"; // Show the filter
                sessionStorage.setItem(`filter_${filterName}_visible`, "true"); // Save visibility state
            }
        });

        // Check if at least one selected filter has a value saved in sessionStorage, then reload the page
        const hasSavedValue = selectedFilters.some((filterName) => {
            const savedValue = sessionStorage.getItem(`filter_${filterName}_value`);
            // if savedValue is null or empty string, return false
            return savedValue && savedValue.trim();
        });
        
        if (hasSavedValue) {
            document.getElementById("filterForm").submit();
        }

        // Get all the unselected checkboxes in the modal
        const unselectedFilters = Array.from(
            document.querySelectorAll(".filter-checkbox:not(:checked)")
        ).map((checkbox) => checkbox.value);

        // Hide the unselected filters on the main page
        unselectedFilters.forEach((filterName) => {
            const filterElement = document.querySelector(
                `.filter-container[data-filter-name="${filterName}"]`
            );
            if (filterElement) {
                filterElement.style.display = "none"; // Hide the filter
                sessionStorage.setItem(`filter_${filterName}_visible`, "false"); // Save hidden state
            }
        });

        // Reset hidden filters value
        unselectedFilters.forEach((filterName) => {
            const filterElement = document.querySelector(
                `.filter-container[data-filter-name="${filterName}"]`
            );
            if (filterElement) {
                filterElement.querySelector("input, select").value = ""; 
            }
        });

        const hasSavedValue_unchecked = unselectedFilters.some((filterName) => {
            const savedValue = sessionStorage.getItem(`filter_${filterName}_value`);
            // if savedValue is null or empty string, return false
            return savedValue && savedValue.trim();
        });

        if (hasSavedValue_unchecked) {
            document.getElementById("filterForm").submit();
        }

        // Close the modal after applying
        closeFilterModal();
    }

    // Restore the checkbox state in the modal
    function restoreModalCheckboxState() {
        document.querySelectorAll(".filter-checkbox").forEach((checkbox) => {
            const filterName = checkbox.value;
            const isVisible = sessionStorage.getItem(
                `filter_${filterName}_visible`
            ) === "true";
            checkbox.checked = isVisible; // Check the checkbox if the filter is visible
        });
    }


    // Restore value of visible filters from sessionStorage
    function restoreFilterValues() {
        document.querySelectorAll(".filter-container input, .filter-container select").forEach(input => {
            const filterName = input.getAttribute("name");
            const savedValue = sessionStorage.getItem(`filter_${filterName}_value`);
            if (savedValue !== null) {
                input.value = savedValue; // Restore the saved value
            }
        });
    }

    // When click on Reset Filter Button
    function resetFilter() {
        // Clear all filter values and their values in sessionStorage
        document.querySelectorAll(".filter-container input, select").forEach(filterInput => {
            filterInput.value = "";
            const filterName = filterInput.closest(".filter-container").getAttribute("data-filter-name");
            sessionStorage.removeItem(`filter_${filterName}_value`);

        });


    }

    // When click on Delete All Filter Button
    function deleteFilters() {
        sessionStorage.clear();
    }
        
    // When click on "Lọc" Button
    function applyFilter() {
        // Save filter values to sessionStorage if that filter is visible
        document.querySelectorAll(".filter-container").forEach(container => {
            const filterName = container.getAttribute("data-filter-name");
            const filterInput = container.querySelector("input, select");
            if (filterInput && container.style.display !== "none") {
                sessionStorage.setItem(`filter_${filterName}_value`, filterInput.value);
            }
        });
    }
        

    document.addEventListener("DOMContentLoaded", () => {
        // Restore filter visibility and modal state on page load
        restoreFilterVisibility();
        restoreModalFilterState();
        restoreFilterValues();
        restoreModalCheckboxState();
    });
    
    // Restore filter visibility from sessionStorage
    function restoreFilterVisibility() {
        document.querySelectorAll(".filter-container").forEach(container => {
            const filterName = container.getAttribute("data-filter-name");
            const isVisible = sessionStorage.getItem(`filter_${filterName}_visible`) === "true";
            container.style.display = isVisible ? "flex" : "none"; // Restore visibility
        });
    }
    
    // Show a filter when selected in the modal
    function showFilter(filterName) {
        const filterElement = document.querySelector(`.filter-container[data-filter-name="${filterName}"]`);
        if (filterElement) {
            filterElement.style.display = "flex"; // Show the filter
            sessionStorage.setItem(`filter_${filterName}_visible`, "true"); // Save visibility state
            updateModalFilterState(filterName, true); // Mark as selected in the modal
        }
        closeFilterModal(); // Close the modal after selection
    }
    
    // Hide a filter and update sessionStorage
    function removeFilter(closeButton) {
        const filterContainer = closeButton.parentElement;
        const filterName = filterContainer.getAttribute("data-filter-name");

        filterContainer.style.display = "none"; // Hide the filter
        sessionStorage.setItem(`filter_${filterName}_visible`, "false"); // Save hidden state

        // Check if the value of the filter not empty
        if (filterContainer.querySelector("input, select").value) {
        // Clear the saved value for the filter
        sessionStorage.removeItem(`filter_${filterName}_value`);

        // Reset the filter value 
        filterContainer.querySelector("input, select").value = "";

            // Reload the page to apply the filters
            document.getElementById("filterForm").submit();

        }
        // Uncheck the corresponding checkbox in the modal
        const modalCheckbox = document.querySelector(
            `.filter-checkbox[value="${filterName}"]`
        );
        if (modalCheckbox) {
            modalCheckbox.checked = false; // Uncheck the checkbox
        }

        updateModalFilterState(filterName, false); // Unmark as active in the modal

    }
    
    // Restore the selected state of filters in the modal
    function restoreModalFilterState() {
        document.querySelectorAll(".filter-option").forEach(option => {
            const filterName = option.getAttribute("onclick").match(/'([^']+)'/)[1];
            const isVisible = sessionStorage.getItem(`filter_${filterName}_visible`) === "true";
            if (isVisible) {
                option.classList.add("active"); // Mark as active
            } else {
                option.classList.remove("active"); // Remove active state
            }
        });
    }
    
    // Update the selected state of a filter in the modal
    function updateModalFilterState(filterName, isVisible) {
        const filterOption = document.querySelector(`.filter-option[onclick*="'${filterName}'"]`);
        if (filterOption) {
            if (isVisible) {
                filterOption.classList.add("active"); // Mark as active
            } else {
                filterOption.classList.remove("active"); // Unmark as active
            }
        }
    }
    
    // Open and close modal functions
    function openFilterModal() {
        const modal = document.getElementById("filterModal");
        modal.style.display = "flex";
    }
    
    function closeFilterModal() {
        const modal = document.getElementById("filterModal");
        modal.style.display = "none";
    }

    // Validate selection for export
    function validateSelection() {
        const officerCheckboxes = document.querySelectorAll('input[name="officers"]');
        const isAnyOfficerSelected = Array.from(officerCheckboxes).some(checkbox => checkbox.checked);
    
        const fieldCheckboxes = document.querySelectorAll('input[name="{{ form.fields.name }}"]');
        const isAnyFieldSelected = Array.from(fieldCheckboxes).some(checkbox => checkbox.checked);
    
        if (!isAnyOfficerSelected && !isAnyFieldSelected) {
            showWarningModal("Vui lòng chọn ít nhất một cán bộ và một trường thông tin để xuất dữ liệu!");
            return false;
        } else if (!isAnyOfficerSelected) {
            showWarningModal("Vui lòng chọn ít nhất một cán bộ để xuất dữ liệu!");
            return false;
        } else if (!isAnyFieldSelected) {
            showWarningModal("Vui lòng chọn ít nhất một trường thông tin để xuất dữ liệu!");
            return false;
        }
    
        return true; // All validations pass
    }
    
    // Show and close warning modal
    function showWarningModal(message) {
        const warningModal = document.getElementById("warningModal");
        const warningText = warningModal.querySelector("p");
        if (warningText) {
            warningText.innerText = message; // Set custom message
        }
        warningModal.style.display = "block"; // Show modal
    }
    
    function closeWarningModal() {
        const warningModal = document.getElementById("warningModal");
        warningModal.style.display = "none"; // Hide modal
    }
    
</script>
